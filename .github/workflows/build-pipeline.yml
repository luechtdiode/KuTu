# For most projects, this workflow file will not need changing; you simply need
# to commit it to your repository.
#
# You may wish to alter this file to override the set of languages analyzed,
# or to provide custom queries or build logic.
name: "Build-Pipeline"

on: [push]
#    branches: [master]
#  pull_request:
#    # The branches below must be a subset of the branches above
#    branches: [master]
#  schedule:
#    - cron: '0 9 * * 2'

jobs:
  build-client:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          # We must fetch at least the immediate parents so that if this is
          # a pull request then we can checkout the head.
          fetch-depth: 2

      # If this run was triggered by a pull request event, then checkout
      # the head of the pull request instead of the merge commit.
      - run: git checkout HEAD^2
        if: ${{ github.event_name == 'pull_request' }}
      # - run: ./build-client.sh
      - name: Build Mobile-App
        uses: actions/setup-node@v1
        with:
          languages: javascript
          # with:
          #  node-version: 12.x
      - run: |
          cd newclient/resultcatcher
          npm install -g cordova ionic
          npm i
          ionic build --prod --engine=browser
          cd ../..
          rm -rf ./src/main/resources/app
          mkdir ./src/main/resources/app
          cp -R -f ./newclient/resultcatcher/www/* ./src/main/resources/app
          // git add ./src/main/resources/app
          //git commit -a -m "update with generated Client from Github Actions CI for build ${{env.GITHUB_RUN_NUMBER}} with [skip ci]"
          export GIT_TAG=ci-build-client-${{env.GITHUB_REF}}-$(date -u "+%Y-%m-%d")-${{env.GITHUB_RUN_NUMBER}}
          echo $GIT_TAG
          //git tag $GIT_TAG -a -m "TravisCI client build $TRAVIS_BUILD_NUMBER"
          // if ! git push -fq --follow-tags https://$GH_ACCESS_TOKEN@github.com/luechtdiode/KuTu.git ${{env.GITHUB_REF}} > /dev/null 2>&1; then err "failed to push git changes"; return1; fi

      - name: Archive production artifacts
        uses: actions/upload-artifact@v2
        with:
          name: mobile-client-app
          path: |
            newclient/resultcatcher/www
  build-server:
    needs: build-client
    runs-on: ubuntu-latest
    steps:
      - name: Cache Maven packages
        uses: actions/cache@v2
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
      - name: Download a single artifact
        uses: actions/download-artifact@v2
        with:
          name: mobile-client-app
      - name: Java Setup
        run: |
          export OS=Linux
          . ./prepare_jdk.sh
      - name: Maven Build
        run: |
          mvn clean install


#  build-docker:
#    needs: build
#    runs-on: ubuntu-latest
#    steps:
#      - run: ./build-docker.sh
#  build-linux-binary:
#    needs: build
#    runs-on: ubuntu-latest
#    steps:
#      - run: ./build-linux-binary.sh
#  build-win-binary:
#    needs: build
#    runs-on: windows-latest
#    steps:
#      - run: ./build-win-binary.sh
#  build-osx-binary:
#    needs: build
#    runs-on: macos-latest
#    steps:
#      - run: ./build-osx-binary.sh
