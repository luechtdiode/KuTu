<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/" />
    </ion-buttons>

    <ion-title>{{geraetName()}}</ion-title>
    <ion-note slot="end"><div class="athlet">{{item.vorname + ' ' + item.name}}</div><div class="riege">{{wertung.riege}}</div></ion-note>
  </ion-toolbar>
</ion-header>

<ion-content>
    @if (hasMedia) {
      <ion-list>
        <ion-item>
          <iframe width="100%" height="166" scrolling="no" frameborder="no" allow="autoplay"
            src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/10510425&color=%23ff5500&auto_play=false&hide_related=true&show_comments=false&show_user=false&show_reposts=false&show_teaser=false"></iframe>
          <div
            style="font-size: 10px; color: #cccccc;line-break: anywhere;word-break: normal;overflow: hidden;white-space: nowrap;text-overflow: ellipsis; font-family: Interstate,Lucida Grande,Lucida Sans Unicode,Lucida Sans,Garuda,Verdana,Tahoma,sans-serif;font-weight: 100;">
            <a href="https://soundcloud.com/luechtdiode" title="luechtdiode" target="_blank"
              style="color: #cccccc; text-decoration: none;">luechtdiode</a> · <a
              href="https://soundcloud.com/luechtdiode/gletscherschmelze" title="Gletscherschmelze" target="_blank"
              style="color: #cccccc; text-decoration: none;">Gletscherschmelze
            </a>
          </div>
          <audio controls>
            <source [attr.src]="mediaSource" type="audio/mp3">
            <source [attr.src]="mediaSource" type="audio/ogg">
            <source [attr.src]="mediaSource" type="audio/wav">
          </audio>
        </ion-item>
      </ion-list>
    }
  <form #wertungsform="ngForm" (ngSubmit)="saveNext(wertungsform)" (keyup.enter)="saveNext(wertungsform)">
    @for (exercice of exercices; track exercice; let block = $index) {
      <ion-list>
        <ion-item-divider><h2>{{block +1}}. Übung</h2></ion-item-divider>
        @for (wertung of exercice; track wertung) {
          <app-wertung-avg-calc [name]='wertung.name+wertung.index' [waiting]="waiting"
            [valueTitle]="wertung.name" [fixed]="wertung.scale" [ngModel]="wertung.value" (ngModelChange)="updateVariable($event, wertung)" [disabled]="!editable()" />
        }
      </ion-list>
    }
    @if (exercices.length > 0) {
      <ion-list>
        <ion-item-divider><h2>Endnote</h2></ion-item-divider>
        @if (isDNoteUsed) {
          <ion-item>
            <ion-input [label]='dNoteLabel' [ngModel]='wertung.noteD' type="number" readonly name="dEndnote" [disabled]="!editable()" />
          </ion-item>
        }
        <ion-item>
          <ion-input [label]='eNoteLabel' #endnote [ngModel]='wertung.noteE' type="number" readonly name="eEndnote" [disabled]="!editable()" />
        </ion-item>
        <ion-item>
          <ion-input label="Endnote" #endnote [ngModel]='wertung.endnote' type="number" readonly name="endnote" [disabled]="!editable()" />
        </ion-item>
        @if (editable()) {
          <ion-button size="large" expand="block" #btnValidate (click)='validate(wertungsform)' [disabled]="waiting || !wertungsform.valid" color="secondary">
          <ion-icon slot="start" name="acalculator-outline" />Endnote berechnen</ion-button>
        }
      </ion-list>
    }
    @if (exercices.length == 0) {
      <ion-list>
        @if (isDNoteUsed) {
          <app-wertung-avg-calc #dnote name="noteD" [waiting]="waiting" [valueTitle]="dNoteLabel" [fixed]="1" [(ngModel)]="dNote" [disabled]="!editable()" />
        }
        <app-wertung-avg-calc #enote name="noteE" [waiting]="waiting" [valueTitle]="eNoteLabel" [fixed]="3" [(ngModel)]="eNote" [disabled]="!editable()" />
        <ion-item>
          <ion-input label="Endnote" #endnote [ngModel]='wertung.endnote' type="number" readonly name="endnote" [disabled]="!editable()" />
        </ion-item>
        @if (editable()) {
          <ion-button size="large" expand="block" #btnValidate (click)='validate(wertungsform)' [disabled]="waiting || !wertungsform.valid" color="secondary">
          <ion-icon slot="start" name="calculator-outline" />Endnote berechnen</ion-button>
        }
      </ion-list>
    }
    <ion-list>
      @if (!wertungsform.valid && editable()) {
        <ion-item>
          Ungültige Eingabe. Die Werte müssen im Format ##.## (2-3 Nachkommastellen mit Dezimalpunkt) eingegeben werden.
        </ion-item>
      }
      @if (!editable()) {
        <ion-item>
          An diesem Gerät macht {{item.vorname + ' ' + item.name}} Pause. Es können keine Resultate erfasst werden.
        </ion-item>
      } else {
        <ion-button size="large" expand="block" type="submit" #btnSaveNext [disabled]="waiting || !wertungsform.valid" color="success">
        <ion-icon slot="start" name="arrow-forward-circle-outline" />Speichern & Weiter</ion-button>
        <ion-button size="large" expand="block" [disabled]="waiting || !wertungsform.valid"  color="secondary" (click)='saveClose(wertungsform)'>
        <ion-icon slot="start" name="checkmark-circle" />Speichern</ion-button>
      }
    </ion-list>
    @if (nextItem) {
      <ion-list>
        @if (nextItem && nextItem.geschlecht==='Turner') {
          <ion-item-divider>Nächster Turner</ion-item-divider>
        }
        @if (nextItem && nextItem.geschlecht==='Turnerin') {
          <ion-item-divider>Nächste Turnerin</ion-item-divider>
        }
        @if (nextItem) {
          <ion-item-sliding #slidingAthletItem>
            <ion-item (click)='itemTapped(slidingAthletItem)'>
              <ion-toolbar>
                <ion-note slot="end"><div class="athlet">{{nextItem.vorname + ' ' + nextItem.name}}</div><div class="riege">{{nextItem.wertung.riege}}</div></ion-note>
              </ion-toolbar>
              <ion-icon slot="end" name="arrow-forward-circle-outline" />
            </ion-item>
            <ion-item-options side="end">
              <ion-item-option color="primary" (click)="next(wertungsform, slidingAthletItem)">
                <ion-icon name="arrow-forward-circle-outline" ios="md-arrow-forward-circle-outline" />
                {{nextItem.vorname + ' ' + nextItem.name}}
              </ion-item-option>
            </ion-item-options>
          </ion-item-sliding>
        }
      </ion-list>
    }
  </form>
</ion-content>
